<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hyrax.microservice.project.data.mapper.TaskMapper">

    <resultMap id="taskEntityResultMap" type="com.hyrax.microservice.project.data.entity.TaskEntity">
        <id column="task_id" jdbcType="BIGINT" property="taskId" javaType="java.lang.Long"/>
        <result column="task_name" jdbcType="VARCHAR" property="taskName" javaType="java.lang.String"/>
        <result column="description" jdbcType="VARCHAR" property="description" javaType="java.lang.String"/>
        <result column="task_index" jdbcType="BIGINT" property="taskIndex" javaType="java.lang.Long"/>
    </resultMap>

    <sql id="getBoardId">
        select distinct b.board_id
        from board b inner join board_column c
        on b.board_id = c.board_id and board_name = #{task.boardName}
    </sql>

    <sql id="getBoardIdByBoardName">
        select distinct b.board_id
        from board b inner join board_column c
        on b.board_id = c.board_id and board_name = #{boardName}
    </sql>

    <sql id="getColumnIdByColumnName">
        select distinct c.column_id
        from board b inner join board_column c
        on b.board_id = c.board_id and column_name = #{task.columnName}
    </sql>

    <sql id="getColumnIdByNewColumnName">
        select distinct c.column_id
        from board b inner join board_column c
        on b.board_id = c.board_id and column_name = #{newColumnName}
    </sql>

    <sql id="sumTaskIndexByColumnName">
        select count(t.task_id)
        from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{task.boardName} and c.column_name = #{task.columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id
    </sql>

    <sql id="getLastTaskIndexByNewColumnName">
        select t.task_index
        from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{newColumnName}
        inner join (select * from task) t
        on b.board_id = t.board_id and c.column_id = t.column_id
        order by t.task_index desc
        limit 1
    </sql>

    <select id="selectAllByBoardNameAndColumnName" resultType="com.hyrax.microservice.project.data.entity.TaskEntity"
            resultMap="taskEntityResultMap">
        select t.task_id, t.task_name, t.description, t.task_index
        from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id
        order by t.task_index
    </select>

    <insert id="insert" useGeneratedKeys="true" keyProperty="task.taskId" keyColumn="task_id">
        insert into task (board_id, column_id, task_name, description, task_index)
        select (<include refid="getBoardId"/>), (<include refid="getColumnIdByColumnName"/>), #{task.taskName},
        #{task.description}, (<include refid="sumTaskIndexByColumnName"/>) + 1
    </insert>

    <insert id="assignDefaultUserToTask">
        insert into task_assigned_user (board_id, task_id, username)
        select (<include refid="getBoardIdByBoardName"/>), #{taskId}, 'Not assigned'
    </insert>

    <update id="assignUserToTask">
        update board b inner join task_assigned_user tau
        on b.board_id = tau.board_id and b.board_name = #{boardName} and tau.task_id = #{taskId}
        set tau.username = #{username}
    </update>

    <insert id="watchTask">
        insert into task_watched_user (board_id, task_id, username)
        select (<include refid="getBoardIdByBoardName"/>), #{taskId}, #{username}
    </insert>

    <delete id="unwatchTask">
        delete twu from board b inner join task_watched_user twu
        on b.board_id = twu.board_id and b.board_name = #{boardName} and twu.task_id = #{taskId} and twu.username = #{username}
    </delete>

    <update id="update">
        update board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id and t.task_id = #{taskId}
        set t.task_name = #{taskName}, t.description = #{description}
    </update>

    <update id="updateIndex">
        update board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id and t.task_id = #{taskId}
        set t.task_index = #{newTaskIndex}
    </update>

    <update id="updatePositionInColumn">
        update board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id and t.task_id = #{taskId}
        set t.task_index = IFNULL((<include refid="getLastTaskIndexByNewColumnName"/>) + 1, 1), t.column_id = (<include
            refid="getColumnIdByNewColumnName"/>)
    </update>

    <delete id="delete">
        delete t from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id and t.task_id = #{taskId}
    </delete>

    <delete id="deleteAllByBoardNameAndColumnName">
        delete t from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id
    </delete>

    <delete id="deleteAllByBoardName">
        delete t from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id
    </delete>

    <delete id="deleteAssignedUserFromTask">
        delete tau from board b inner join task_assigned_user tau
        on b.board_id = tau.board_id and b.board_name = #{boardName} and tau.task_id = #{taskId}
    </delete>

    <delete id="deleteAssignedUsersFromTasksByColumnName">
        delete tau from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id
        inner join task_assigned_user tau
        on b.board_id = tau.board_id and t.task_id = tau.task_id
    </delete>

    <delete id="deleteAssignedUsersFromTasksByBoardName">
        delete tau from board b inner join task_assigned_user tau
        on b.board_id = tau.board_id and b.board_name = #{boardName}
    </delete>

    <delete id="deleteWatchedUsersFromTask">
        delete twu from board b inner join task_watched_user twu
        on b.board_id = twu.board_id and b.board_name = #{boardName} and twu.task_id = #{taskId}
    </delete>

    <delete id="deleteWatchedUsersFromTasksByColumnName">
        delete twu from board b inner join board_column c
        on b.board_id = c.board_id and b.board_name = #{boardName} and c.column_name = #{columnName}
        inner join task t
        on b.board_id = t.board_id and c.column_id = t.column_id
        inner join task_watched_user twu
        on b.board_id = twu.board_id and t.task_id = twu.task_id
    </delete>

    <delete id="deleteWatchedUsersFromTasksByBoardName">
        delete twu from board b inner join task_watched_user twu
        on b.board_id = twu.board_id and b.board_name = #{boardName}
    </delete>

</mapper>